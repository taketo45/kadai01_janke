<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<script src="js/jquery-2.1.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<link rel="stylesheet" href="css/reset.css">
<link rel="stylesheet" href="css/sample.css">
<title>じゃんけん</title>
</head>
<body>
  <audio src="./sound/junkenpon.m4a" id="junkenponSound" class="sound"></audio>
  <audio src="./sound/win.m4a" id="winSound" class="sound"></audio>
  <audio src="./sound/lose.m4a" id="loseSound" class="sound"></audio>
  <audio src="./sound/even.mp4" id="evenSound" class="sound"></audio>

<header>
  <h1>じゃんけん</h1>
</header>
<main class="mainarea">
  <section class="insertCoin">
    <div class="midleDisplay">
      <div class="insert">
        <button id="tenYenInsert">10円投入</button>
        <button id="hundredYenInsert">100円投入</button>
      </div>
      <div class="midleDisplay">
        <div id="medalTitle">メダル数：</div>
        <div id="medalnum"></div>
      </div>
      <div class="midleDisplay">
        <button id="medalSet">メダルを持ち帰る</button>
        <button id="medalGet">メダルを使う</button>
      </div>
    </div>
  </section>
  <section class="multierea">
    <div class="multibox">
      <ul id="multidisplay">
        <li class="multi" id="multi02">2</li>
        <li class="multi" id="multi04">4</li>
        <li class="multi" id="multi08">8</li>
        <li class="multi" id="multi16">16</li>
        <li class="multi" id="multi32">32</li>
      </ul>
    </div>
  </section>


  <section class="result">
    <h2><div id="judgment"></div></h2> 
  </section>

  <p class="pccomment"></p>
  <div id="junkenDisplay">
    <div id="pc_hands"></div>
  </div>
  <!-- <div>あなたの出した手
    <div id="your_hands"></div>
  </div> -->
  


  <section class="buttonerea">
    <div class="gamebutton">
      <ul id="janken">
        <li><button id="start_btn" class="game-btn"><img src="./img/startbtn.jpeg" width="105" alt="スタート"></button></li>
        <li><button id="gu_btn" class="game-btn"><img src="./img/gu.png" width="60" alt="グー"></button></li>
        <li><button id="cho_btn" class="game-btn"><img src="./img/choki.png" width="60" alt="チョキ"></button></li>
        <li><button id="par_btn" class="game-btn"><img src="./img/pa.png" width="60" alt="パー"></button></li>
      </ul>
    </div>
    
  </section>
</main>

<footer>
  <div class="keybind">
    <div class="startKey">[S]</div>
    <div class="guKey">[G]</div>
    <div class="chokiKey">[K]</div>
    <div class="paKey">[P]</div>
  </div>

</footer>
<script>
//じゃんけん用のSCRIPTを書いてください

let pcHand = 0;
let yourHand = 0;
const GU = 1;
const CHOKI = 2;
const PA = 3;
const guImg = '<img src="./img/gu.png" width="50">';
const choImg = '<img src="./img/choki.png" width="50">';
const paImg = '<img src="./img/pa.png" width="50">';
const guImg_L = '<img src="./img/gu.png" width="250">';
const choImg_L = '<img src="./img/choki.png" width="250">';
const paImg_L = '<img src="./img/pa.png" width="250">';
const $startBtn = $("#start_btn");
const $guBtn = $("#gu_btn");
const $choBtn = $("#cho_btn");
const $paBtn = $('#par_btn');
const $judgment = $('#judgment');
const judge = "";
const $yourHands = $('#your_hands');
const $pcHands = $('#pc_hands');
const evenMsg = '<h2>あいこ</h2>';
const loseMsg = '<h2>まけ</h2>';
const winMsg = '<h2>かち</h2>';
const clearMsg = '<h2></h2>';
const guchopaImg = '<img src="./img/guchopa.gif" width="150">';
const junkenponSound = $("#junkenponSound").get(0);
const winSound = $("#winSound").get(0);
const loseSound = $("#loseSound").get(0);
const evenSound = $("#evenSound").get(0);
let winCount = 0;
const $multi02 = $("#multi02");
const $multi04 = $("#multi04");
const $multi08 = $("#multi08");
const $multi16 = $("#multi16");
const $multi32 = $("#multi32");
const $multiAll = $(".multi");
const $medalnum = $("#medalnum");
let medal = 0;
let audio;
const $tenYenInsert = $("#tenYenInsert");
const $hundredYenInsert = $("#hundredYenInsert");
const $medalSet = $("#medalSet");
const $medalGet = $("#medalGet");
const $document = $(document);
let audiAble = false;
let $sound = $(".sound");
let isGuChokiPaAble = false;
let isStartAble = true;
const S_KEY = 83;
const G_KEY = 71;
const K_KEY = 75;
const P_KEY = 80;
const BG_NONE = 0;
const BG_LITTLE = 1;
const BG_MANY = 2;
const BG_LOSE = 9;
const $body = $("body");
const BG_IMG = 'background-image';
const urlNone = 'none';
const urlLittle = 'url(./img/raining-money-26.gif)';
const urlMany = 'url(./img/raining-money-12.gif)';
const urlLose = 'url(./img/lose.png)';
const BG_COLOR = "background-color";
const DEFALT_BG_CLR = "#f0e68c"; 
const INIT_BTN_CLR = "#c3f2ff";
const PUSH_BTN_CLR = "#0066CC";
const INIT_MULTI_CLR = "#ffcaca";
const APPLY_MULTI_CLR = "#f98fab";
const BUY_MEDAL_MESSAGE = "メダルを購入してください";
const COOKIE_NAME = '01_guy_janken';
let isGaming = false;

$document.ready(function() {
  // グー、チョキ、パーのボタンを最初に無効化
  guchopaDisable();
  btnHideControl();
  audio = junkenponSound;
  // audioStop();
  medalInfo();
  bgGifDisplay(BG_LITTLE);

  $tenYenInsert.on("click",function(){
    if(isGaming) return;
    medalPayment(1);
  });
  $hundredYenInsert.on("click",function(){
    if(isGaming) return;
    medalPayment(10);
  });

  $medalSet.on("click",function(){
    if(isGaming) return;
    setCookie();
    medal = 0;
    medalInfo();
  });
  $medalGet.on("click",function(){
    if(isGaming) return;
    medal += getCookie()||0;
    deleteGookie();
    medalInfo();
  });



$startBtn.on("click",function(){
  if(isGaming) return;
  startFunction();
});

$guBtn.on("click",function(){
  jankenGame(GU);
});



$choBtn.on("click",function(){
  jankenGame(CHOKI);
});


$paBtn.on("click",function(){
  jankenGame(PA);
});


$document.keydown(function (e) {
  const key = e.keyCode;
  if(key == S_KEY){
    startFunction();
  }
  if(key === G_KEY){
    if(!isGuChokiPaAble){
      return;
    }
    jankenGame(GU);
  }
  if(key === K_KEY){
    if(!isGuChokiPaAble){
      return;
    }
    jankenGame(CHOKI);
  }
  if(key === P_KEY){
    if(!isGuChokiPaAble){
      return;
    }
    jankenGame(PA);
  }
});


function startFunction(){
  if(!isPlayAble()||isGaming) return;
  startDisable();
  medalConsumption();
  initStatus();
  animateBtn($startBtn);
  audio = junkenponSound;
  audio.load();
  audio.play();
  // console.log('sound');
  guchopaRoundFunction();
  clearBtn();
  guchopaEnable();
  btnShowControl();
  bgGifDisplay(BG_NONE);
  isGaming = true;
}

function animateBtn($btn) {
  $btn.animate({width: "90px"}, 100)
    .promise().done(function() {
      setTimeout(() => {
        $btn.animate({width: "105px"}, 100);
      }, 100);
    });
}



function jankenGame(dashite) {
  guchopaDisable();
  yourHand = dashite;
  const handMap = {
    [GU]: { img: guImg, btn: $guBtn },
    [CHOKI]: { img: choImg, btn: $choBtn },
    [PA]: { img: paImg, btn: $paBtn },
  }; 
  const { img, btn } = handMap[dashite];

  clearBtn();
  btn.css("background", PUSH_BTN_CLR);
  $yourHands.html(img);
  pcJunken();
  audio.pause();
  judgement();
  medalInfo();
}


function clearBtn() {
  $guBtn.css("background",INIT_BTN_CLR);
  $choBtn.css("background",INIT_BTN_CLR);
  $paBtn.css("background",INIT_BTN_CLR);
}

  function pcJunken() {
    //PCのじゃんけん
    pcHand = Math.ceil(Math.random() * 3);

    if(pcHand === GU) {
        $pcHands.html(guImg_L); //width="250"

    }
    if(pcHand === CHOKI) {
      $pcHands.html(choImg_L);
    }
    if(pcHand === PA) {
      $pcHands.html(paImg_L);
    }
  }

  function judgement() {

    //勝ちパターン
    if((yourHand === GU && pcHand === CHOKI)||(yourHand === CHOKI && pcHand === PA)||(yourHand === PA && pcHand===GU)){
      // audio.currentTime = 0;
      audio = winSound;
      audio.load();
      audio.play();
      $judgment.html(winMsg);
      btnHideControl(yourHand);
      // guchopaDisable();
      winCount += 1;
      multiDisplay();
      setTimeout(() =>{
        isGaming = false;
        startEnable();
      } ,1000);
    }

    //負けパターン
    if((pcHand === GU && yourHand === CHOKI)||(pcHand === CHOKI && yourHand === PA)||(pcHand === PA && yourHand===GU)){
      $judgment.html(loseMsg);
      // audio.currentTime = 0;
      audio = loseSound;
      audio.load();
      audio.play();
      btnHideControl(yourHand);
      // guchopaDisable();
      multiClear();
      bgGifDisplay(BG_LOSE);
      setTimeout(() =>{
        isGaming = false;
        startEnable();
      } ,1000);
    }
    //あいこパターン イコール
    if(yourHand === pcHand) {
      $judgment.html(evenMsg);
      // audio.currentTime = 0;
      audio = evenSound;
      audio.load();
      audio.play();
      // startDisable();
      setTimeout(()=>{
        guchopaRoundFunction();
        guchopaEnable();
      }, 600);
    }

  }

  function guchopaRoundFunction() {
      $pcHands.html(guchopaImg);
    }

  function guchopaDisable(){
    $("#gu_btn, #cho_btn, #par_btn").prop("disabled", true);
    isGuChokiPaAble = false;
    // console.log('guchopaDisable');
  }
  
  function guchopaEnable(){
    $("#gu_btn, #cho_btn, #par_btn").prop("disabled", false);
    isGuChokiPaAble = true;
    // console.log('guchopaEnable');
  }



  function btnHideControl(yourHand=0) {
    if(yourHand === GU){
      $("#cho_btn, #par_btn").hide();
    } 
    if(yourHand === CHOKI){
      $("#gu_btn,#par_btn").hide();
    } 
    if(yourHand === PA){
      $("#gu_btn,#cho_btn").hide();
    } 
    if(yourHand === 0) {
      $("#gu_btn, #cho_btn, #par_btn").hide();
    }
  }

  function btnShowControl(){
    $("#gu_btn, #cho_btn, #par_btn").show();
  }
  
  function startDisable(){
    $("#start_btn").prop("disabled", true);
    isStartAble = false;
    // console.log('startDisable');
  }
  
  function startEnable(){
    $("#start_btn").prop("disabled", false);
    isStartAble = true;
    // bgGifDisplay(BG_NONE);
    // console.log('startEnable');
  }

  function initStatus() {
    pcHand = 0;
    yourHand = 0;
    $yourHands.html(clearMsg);
    $judgment.html(clearMsg);
    medalInfo();
    bgGifDisplay(BG_NONE);
  }


  
  function multiDisplay() {
    const multiMap = {
    [1]: { $disp: $multi02, medal: 2, img: BG_LITTLE },
    [2]: { $disp: $multi04, medal: 4, img: BG_LITTLE },
    [3]: { $disp: $multi08, medal: 8, img: BG_LITTLE },
    [4]: { $disp: $multi16, medal: 16, img: BG_MANY },
    [5]: { $disp: $multi32, medal: 32, img: BG_MANY },
    };

    const { $disp, medal, img } = multiMap[winCount];
    $multiAll.css(BG_COLOR,INIT_MULTI_CLR);
    $disp.css(BG_COLOR,APPLY_MULTI_CLR);
    medalPayment(medal);
    bgGifDisplay(img);

    // if(winCount === 1) {
    //   $multi02.css(BG_COLOR,APPLY_MULTI_CLR);
    //   medalPayment(2);
    //   bgGifDisplay(BG_LITTLE);
    // }
    // if(winCount === 2) {
    //   $multi04.css(BG_COLOR,APPLY_MULTI_CLR);
    //   medalPayment(4);
    //   bgGifDisplay(BG_LITTLE);
    // }
    // if(winCount === 3) {
    //   $multi08.css(BG_COLOR,APPLY_MULTI_CLR);
    //   medalPayment(8);
    //   bgGifDisplay(BG_LITTLE);
    // }
    // if(winCount === 4) {
    //   $multi16.css(BG_COLOR,APPLY_MULTI_CLR);
    //   medalPayment(16);
    //   bgGifDisplay(BG_MANY);
    // }
    // if(winCount === 5) {
    //   $multi32.css(BG_COLOR,APPLY_MULTI_CLR);
    //   medalPayment(32);
    //   bgGifDisplay(BG_MANY);
    //   ending();
    // }
  }

  function bgGifDisplay(bgtype=0){
    if(bgtype === BG_NONE){ // 0
      $body.css(BG_IMG,urlNone);
    }
    if(bgtype === BG_LITTLE){ // 1
      $body.css(BG_IMG,urlLittle);
    }
    if(bgtype === BG_MANY){ // 2
      $body.css(BG_IMG,urlMany);
    }
    if(bgtype === BG_LOSE){ // 9
      $body.css(BG_IMG,urlLose);
    }
  }

  function multiClear() {
    winCount = 0;
    $multiAll.css(BG_COLOR,INIT_MULTI_CLR);
  }

  function ending() {
    winCount = 0;
    // なんかムービー
  }

  function medalPayment(num) {
    medal += num;
    medalInfo();
  }

  function medalConsumption() {
    medal -= 1;
    medalInfo();
    // console.log('medalConsumption()');
  }

  function medalInfo() {
    $medalnum.html('<h4>' + medal + '</h4>');
  }

  function isPlayAble() {
    if(medal > 0){
      return true;
    } else {
      alert(BUY_MEDAL_MESSAGE);
      return false;
    }
  }

  function setCookie(){
    $.cookie(COOKIE_NAME,medal);
  }
  function getCookie(){
    return Number($.cookie(COOKIE_NAME));
  }
  function deleteGookie(){
    $.removeCookie(COOKIE_NAME);
  }
  function audioStop(){
    if(!audiAble){
      return;
    }
    $sound.hide();
    audiAble = false;
  }

  function audioStart(){
    if(audiAble){
      return;
    }
    $sound.show();
    audiAble = true;
  }

});


</script>
</body>
</html>
